<!DOCTYPE html>
<html>
<head>
  <title>Camp Scheduler</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .tabs { margin-bottom: 20px; }
    .tab-button { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; background: #f0f0f0; margin-right: 5px; }
    .tab-button.active { background: #007BFF; color: white; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid black; padding: 8px; text-align: center; min-width: 140px; }
    caption { font-weight: bold; margin: 10px 0; }

    .bunk-button { margin: 2px; padding: 5px 10px; cursor: pointer; border: 1px solid #333; border-radius: 4px; display: inline-block; }
    .selected { outline: 3px solid #90CAF9; }
    #unassignedBunks { margin-top: 10px; }
    .divisionWrapper { display: inline-block; margin: 6px; padding: 6px; border: 1px dashed #ccc; border-radius: 6px; }
    .colorPicker { width: 30px; height: 30px; border: none; cursor: pointer; vertical-align: middle; margin-left: 6px; }

    .fieldWrapper { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 6px; }
    .fieldWrapper.unavailable { opacity: 0.5; }
    .fieldTitle { font-weight: 600; margin-right: 10px; cursor: pointer; }

    .activity-button { margin: 2px; padding: 4px 8px; border: 1px solid #333; border-radius: 3px; cursor: pointer; }
    .activity-button.active { background: #007BFF; color: white; }

    .switch { position: relative; display: inline-block; width: 40px; height: 20px; vertical-align: middle; margin-left: 8px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
      background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #4CAF50; }
    input:checked + .slider:before { transform: translateX(20px); }

    .continuation { opacity: 0.7; font-style: italic; }
    .league-pill { background:#4CAF50; color:#fff; padding:2px 6px; border-radius:12px; }
  </style>
</head>
<body>
  <h1>Camp Scheduler</h1>

  <div class="tabs">
    <button class="tab-button active" onclick="showTab('setup')">Setup & Configuration</button>
    <button class="tab-button" onclick="showTab('schedule')">Daily Schedule</button>
    <button class="tab-button" onclick="showTab('leagues')">Leagues</button>
  </div>

  <!-- Setup Tab -->
  <div id="setup" class="tab-content active">
    <h3>Add Bunks</h3>
    <input id="bunkInput" placeholder="Enter bunk">
    <button id="addBunkBtn">Add Bunk</button>
    <div id="unassignedBunks"></div>

    <h3>Add Divisions</h3>
    <input id="divisionInput" placeholder="Enter division name">
    <button id="addDivisionBtn">Add Division</button>
    <label style="margin-left:8px;"><input type="checkbox" id="enableColor" checked> Enable colors</label>
    <div id="divisionButtons" style="margin-top:8px;"></div>

    <h3>Schedule Increments</h3>
    <select id="increment">
      <option value="15">15 minutes</option>
      <option value="30" selected>30 minutes</option>
      <option value="45">45 minutes</option>
      <option value="60">60 minutes</option>
    </select>

    <h3>Activity Duration</h3>
    <select id="activityDuration">
      <option value="15">15 minutes</option>
      <option value="30" selected>30 minutes</option>
      <option value="45">45 minutes</option>
      <option value="60">60 minutes</option>
      <option value="90">90 minutes</option>
    </select>

    <button onclick="generateTimes()">Generate</button>

    <h3>Add Fields/Courts</h3>
    <input id="fieldInput" placeholder="Enter field/court name (e.g., Court #1)">
    <button id="addFieldBtn">Add Field/Court</button>
    <div id="fieldList"></div>

    <h3>Add Special Activities</h3>
    <input id="specialInput" placeholder="Enter special activity (e.g., Canteen)">
    <button id="addSpecialBtn">Add Special Activity</button>
    <div id="specialList"></div>
  </div>

  <!-- Schedule Tab -->
  <div id="schedule" class="tab-content"></div>

  <!-- Leagues Tab -->
  <div id="leagues" class="tab-content">
    <h3>Leagues Setup</h3>
    <div id="leaguesContainer"></div>
  </div>

  <script>
    // -------------------- State --------------------
    let bunks = [];
    let divisions = {};                 // { [divName]: { bunks:[], color, start, end } }
    let availableDivisions = [];
    let selectedDivision = null;

    let divisionTimes = {};             // { [divName]: [ "11:00 AM - 11:15 AM", ... ] }
    let fields = [];                    // [{ name, activities:[], available:true }]
    let specialActivities = [];         // [{ name, available:true }]

    let scheduleAssignments = {};       // { [bunkName]: [ {field,sport,continuation,isLeague}, ... ] } (per its division's length)
    let activityDuration = 30;

    const defaultColors = ['#4CAF50','#2196F3','#E91E63','#FF9800','#9C27B0','#00BCD4','#FFC107','#F44336','#8BC34A','#3F51B5'];
    let colorIndex = 0;

    const commonActivities = ["Basketball","Baseball","Hockey","Football","Soccer","Volleyball","Lacrosse"];
    const leagueSports = ["Basketball","Hockey","Volleyball","Soccer","Kickball","Punchball","Baseball"];
    let leagues = {};                   // { [divName]: { enabled:boolean, sports:string[] } }

    document.getElementById("activityDuration").onchange = function(){
      activityDuration = parseInt(this.value);
    };

    // -------------------- Helpers --------------------
    function makeEditable(el, save){
      el.ondblclick = e => {
        e.stopPropagation();
        const old = el.textContent;
        const input = document.createElement("input");
        input.type="text"; input.value=old;
        el.replaceWith(input); input.focus();
        function done(){
          const val=input.value.trim();
          if(val && val!==old) save(val);
          el.textContent = val || old;
          input.replaceWith(el);
        }
        input.onblur=done; input.onkeyup=e=>{if(e.key==="Enter")done();};
      };
    }
    function parseTime(str){
      if(!str) return null;
      const m=str.match(/^(\d{1,2}):(\d{2})(\s*)?(AM|PM)$/i);
      if(!m) return null;
      let h=parseInt(m[1],10), min=parseInt(m[2],10), ap=m[4].toUpperCase();
      if(ap==="PM"&&h!==12)h+=12; if(ap==="AM"&&h===12)h=0;
      return new Date(0,0,0,h,min);
    }
    function fmtTime(d){
      let h=d.getHours(), m=d.getMinutes().toString().padStart(2,"0"), ap=h>=12?"PM":"AM";
      h=h%12||12; return `${h}:${m} ${ap}`;
    }

    // -------------------- Tabs --------------------
    function showTab(id){
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`.tab-button[onclick="showTab('${id}')"]`).classList.add('active');
      if(id==='schedule') updateTable();
      if(id==='leagues') renderLeagues();
    }

    // -------------------- Bunks --------------------
    function addBunk(){
      const input=document.getElementById("bunkInput");
      if(input.value.trim()!==""){
        bunks.push(input.value.trim());
        input.value=""; updateUnassigned(); updateTable();
      }
    }
    document.getElementById("addBunkBtn").onclick=addBunk;
    document.getElementById("bunkInput").addEventListener("keyup",e=>{if(e.key==="Enter")addBunk();});

    function updateUnassigned(){
      const container=document.getElementById("unassignedBunks");
      container.innerHTML="";
      bunks.forEach(bunk=>{
        const span=document.createElement("span");
        span.textContent=bunk;
        span.className="bunk-button";
        let assignedDiv=null;
        for(const divName in divisions){
          if(divisions[divName].bunks.includes(bunk)){assignedDiv=divName; break;}
        }
        if(assignedDiv){
          const divColor=divisions[assignedDiv].color;
          span.style.backgroundColor=divColor; span.style.color="#fff";
        }
        span.onclick=()=>{
          if(selectedDivision && (!assignedDiv || assignedDiv!==selectedDivision)){
            for(const divName in divisions){
              const i=divisions[divName].bunks.indexOf(bunk);
              if(i!==-1) divisions[divName].bunks.splice(i,1);
            }
            divisions[selectedDivision].bunks.push(bunk);
            updateUnassigned(); updateTable();
          } else if(!selectedDivision){ alert("Select a division first!"); }
        };
        makeEditable(span,newName=>{
          const idx=bunks.indexOf(bunk); if(idx!==-1) bunks[idx]=newName;
          for(const div of Object.values(divisions)){
            const i=div.bunks.indexOf(bunk); if(i!==-1) div.bunks[i]=newName;
          }
          scheduleAssignments[newName]=scheduleAssignments[bunk]||[];
          delete scheduleAssignments[bunk];
          updateUnassigned(); updateTable();
        });
        container.appendChild(span);
      });
    }

    // -------------------- Divisions --------------------
    function addDivision(){
      const input=document.getElementById("divisionInput");
      if(input.value.trim()==="")return;
      const name=input.value.trim();
      if(!availableDivisions.includes(name)){
        const color=defaultColors[colorIndex%defaultColors.length]; colorIndex++;
        availableDivisions.push(name);
        divisions[name]={bunks:[],color:color,start:null,end:null};
        input.value="";
        setupDivisionButtons(); updateTable(); renderLeagues();
      }
    }
    document.getElementById("addDivisionBtn").onclick=addDivision;
    document.getElementById("divisionInput").addEventListener("keyup",e=>{if(e.key==="Enter")addDivision();});

    function setupDivisionButtons(){
      const cont=document.getElementById("divisionButtons"); cont.innerHTML="";
      const colorEnabled=document.getElementById("enableColor").checked;
      availableDivisions.forEach(name=>{
        const obj=divisions[name];
        const wrap=document.createElement("div"); wrap.className="divisionWrapper";
        const span=document.createElement("span"); span.textContent=name; span.className="bunk-button";
        span.style.backgroundColor=colorEnabled?obj.color:"transparent";
        span.style.color=colorEnabled?"#fff":"inherit";
        span.onclick=()=>{selectedDivision=name; cont.querySelectorAll('span.bunk-button').forEach(el=>el.classList.remove("selected")); span.classList.add("selected");};
        makeEditable(span,newName=>{
          divisions[newName]=divisions[name]; delete divisions[name];
          availableDivisions[availableDivisions.indexOf(name)]=newName;
          if(selectedDivision===name)selectedDivision=newName;
          // move leagues config
          leagues[newName]=leagues[name]||{enabled:false,sports:[]}; delete leagues[name];
          // move times
          divisionTimes[newName]=divisionTimes[name]||[]; delete divisionTimes[name];
          setupDivisionButtons(); updateTable(); renderLeagues();
        });
        wrap.appendChild(span);

        const col=document.createElement("input"); col.type="color"; col.value=obj.color; col.className="colorPicker";
        col.oninput=e=>{obj.color=e.target.value; if(colorEnabled){span.style.backgroundColor=e.target.value; span.style.color="#fff";} updateTable();};
        wrap.appendChild(col);

        // Per-division start/end inputs
        const start=document.createElement("input"); start.placeholder="Start (e.g. 11:00 AM)"; start.style.marginLeft="8px";
        start.value=obj.start||""; start.onchange=()=>{obj.start=start.value;};
        const end=document.createElement("input"); end.placeholder="End (e.g. 4:30 PM)"; end.style.marginLeft="6px";
        end.value=obj.end||""; end.onchange=()=>{obj.end=end.value;};
        wrap.appendChild(start); wrap.appendChild(end);

        cont.appendChild(wrap);
      });
    }

    // -------------------- Time Generation --------------------
    function generateTimes(){
      divisionTimes={};
      availableDivisions.forEach(div=>{
        divisionTimes[div]=generateDivisionTimes(div);
      });
      assignFieldsToBunks(); updateTable();
    }

    function generateDivisionTimes(divName){
      const inc=parseInt(document.getElementById("increment").value);
      const startStr=divisions[divName].start, endStr=divisions[divName].end;
      const start=parseTime(startStr), end=parseTime(endStr);
      if(!start||!end||start>=end) return [];
      let arr=[]; let cur=new Date(start);
      while(cur<end){
        let nxt=new Date(cur.getTime()+inc*60000);
        if(nxt>end) nxt=end;
        arr.push(`${fmtTime(cur)} - ${fmtTime(nxt)}`);
        cur=nxt;
      }
      return arr;
    }

    // -------------------- Fields & Specials --------------------
    function addField(){
      const input=document.getElementById("fieldInput"); const name=input.value.trim();
      if(name){fields.push({name:name,activities:[],available:true}); input.value=""; renderFields();}
    }
    document.getElementById("addFieldBtn").onclick=addField;
    document.getElementById("fieldInput").addEventListener("keyup",e=>{if(e.key==="Enter")addField();});

    function renderFields(){
      const cont=document.getElementById("fieldList"); cont.innerHTML="";
      fields.forEach(field=>{
        const wrap=document.createElement("div"); wrap.className="fieldWrapper"; if(!field.available)wrap.classList.add("unavailable");
        const title=document.createElement("span"); title.className="fieldTitle"; title.textContent=field.name;
        makeEditable(title,newName=>{field.name=newName; renderFields();}); wrap.appendChild(title);

        const toggle=document.createElement("label"); toggle.className="switch";
        const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=field.available;
        cb.onchange=()=>{field.available=cb.checked; renderFields();};
        const slider=document.createElement("span"); slider.className="slider";
        toggle.appendChild(cb); toggle.appendChild(slider); wrap.appendChild(toggle);

        const btnWrap=document.createElement("div"); btnWrap.style.marginTop="8px";
        commonActivities.forEach(act=>{
          const btn=document.createElement("button"); btn.textContent=act; btn.className="activity-button";
          if(field.activities.includes(act))btn.classList.add("active");
          btn.onclick=()=>{if(field.activities.includes(act))field.activities=field.activities.filter(a=>a!==act); else field.activities.push(act); renderFields();};
          btnWrap.appendChild(btn);
        });
        wrap.appendChild(btnWrap);

        const other=document.createElement("input"); other.placeholder="Other activity";
        other.onkeyup=e=>{if(e.key==="Enter"&&other.value.trim()){const v=other.value.trim(); if(!field.activities.includes(v))field.activities.push(v); other.value=""; renderFields();}};
        wrap.appendChild(other);

        if(field.activities.length>0){
          const p=document.createElement("p"); p.style.marginTop="6px"; p.textContent="Activities: "+field.activities.join(", ");
          wrap.appendChild(p);
        }
        cont.appendChild(wrap);
      });
    }

    function addSpecial(){
      const input=document.getElementById("specialInput");
      const name=input.value.trim();
      if(name){specialActivities.push({name:name,available:true}); input.value=""; renderSpecials();}
    }
    document.getElementById("addSpecialBtn").onclick=addSpecial;
    document.getElementById("specialInput").addEventListener("keyup",e=>{if(e.key==="Enter")addSpecial();});

    function renderSpecials(){
      const cont=document.getElementById("specialList"); cont.innerHTML="";
      specialActivities.forEach(act=>{
        const wrap=document.createElement("div"); wrap.className="fieldWrapper"; if(!act.available)wrap.classList.add("unavailable");
        const title=document.createElement("span"); title.className="fieldTitle"; title.textContent=act.name;
        makeEditable(title,newName=>{act.name=newName; renderSpecials();}); wrap.appendChild(title);

        const toggle=document.createElement("label"); toggle.className="switch";
        const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=act.available;
        cb.onchange=()=>{act.available=cb.checked; renderSpecials();};
        const slider=document.createElement("span"); slider.className="slider";
        toggle.appendChild(cb); toggle.appendChild(slider); wrap.appendChild(toggle);
        cont.appendChild(wrap);
      });
    }

    // -------------------- Leagues --------------------
    function renderLeagues(){
      const container=document.getElementById("leaguesContainer");
      container.innerHTML="";
      availableDivisions.forEach(divName=>{
        if(!leagues[divName]) leagues[divName]={enabled:false,sports:[]};
        const wrap=document.createElement("div"); wrap.className="fieldWrapper";
        const title=document.createElement("span"); title.className="fieldTitle"; title.textContent=divName;
        wrap.appendChild(title);

        const toggle=document.createElement("label"); toggle.className="switch";
        const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=leagues[divName].enabled;
        cb.onchange=()=>{leagues[divName].enabled=cb.checked; renderLeagues();};
        const slider=document.createElement("span"); slider.className="slider";
        toggle.appendChild(cb); toggle.appendChild(slider);
        wrap.appendChild(toggle);

        const btnWrap=document.createElement("div"); btnWrap.style.marginTop="8px";
        leagueSports.forEach(sport=>{
          const btn=document.createElement("button"); btn.textContent=sport; btn.className="activity-button";
          if(leagues[divName].sports.includes(sport)) btn.classList.add("active");
          btn.onclick=()=>{
            if(leagues[divName].sports.includes(sport)){
              leagues[divName].sports = leagues[divName].sports.filter(s=>s!==sport);
            } else {
              leagues[divName].sports.push(sport);
            }
            renderLeagues();
          };
          btnWrap.appendChild(btn);
        });
        wrap.appendChild(btnWrap);

        const other=document.createElement("input"); other.placeholder="Other sport";
        other.onkeyup=e=>{
          if(e.key==="Enter"&&other.value.trim()){
            const val=other.value.trim();
            if(!leagues[divName].sports.includes(val)) leagues[divName].sports.push(val);
            other.value=""; renderLeagues();
          }
        };
        wrap.appendChild(other);

        if(leagues[divName].sports.length>0){
          const chosen=document.createElement("p"); chosen.style.marginTop="6px";
          chosen.textContent="Sports: "+leagues[divName].sports.join(", ");
          wrap.appendChild(chosen);
        }
        container.appendChild(wrap);
      });
    }

    // -------------------- Scheduling Core --------------------
    function assignFieldsToBunks() {
      // Setup: available activities
      const availFields = fields.filter(f => f.available && f.activities.length>0);
      const availSpecials = specialActivities.filter(s => s.available);

      if (availableDivisions.length === 0) { scheduleAssignments = {}; return; }

      // Prebuild activity universe
      const allActivitiesFlat = [
        ...availFields.flatMap(f => f.activities.map(act => ({type:"field", field:f, sport:act}))),
        ...availSpecials.map(sa => ({type:"special", field:{name:sa.name}, sport:null}))
      ];
      if (allActivitiesFlat.length === 0) { alert("No activities available."); scheduleAssignments = {}; return; }

      // Clear & init schedules for each bunk
      scheduleAssignments = {};
      availableDivisions.forEach(div=>{
        divisions[div].bunks.forEach(b=>{ scheduleAssignments[b]=[]; });
      });

      const inc = parseInt(document.getElementById("increment").value);
      const spanLen = Math.max(1, Math.ceil(activityDuration / inc)); // how many increments an activity spans

      // Choose league slot per division (initial guess)
      const leagueSlotByDiv = {};
      availableDivisions.forEach(div=>{
        if (leagues[div] && leagues[div].enabled && (divisionTimes[div]||[]).length>0) {
          leagueSlotByDiv[div] = Math.floor(Math.random() * divisionTimes[div].length);
        }
      });

      // Per-division scheduling (independent time grids)
      availableDivisions.forEach(div=>{
        const times = divisionTimes[div] || [];
        if (times.length === 0) return;

        const bunksInDiv = divisions[div].bunks.slice();
        const doneSets = {}; // track per bunk "recently used" to avoid repeats until cycling
        bunksInDiv.forEach(b=> doneSets[b] = new Set());

        for (let s = 0; s < times.length; s++) {
          const usedFieldsThisSlot = new Set(); // prevent two bunks same field/time

          // First, mark any continuations already running from previous span
          bunksInDiv.forEach(bunk=>{
            const entryPrev = scheduleAssignments[bunk][s];
            if (entryPrev && entryPrev.continuation) {
              usedFieldsThisSlot.add(entryPrev.field);
            }
          });

          // For each bunk in the division, place activity or continuation
          for (let bunk of bunksInDiv) {
            // If a continuation already exists at this slot, just keep it and continue
            if (scheduleAssignments[bunk][s] && scheduleAssignments[bunk][s].continuation) continue;

            // Check if previous slots started a span that should continue
            let continued = false;
            // Find the nearest non-empty entry before s
            let lastIdx = s-1;
            while (lastIdx>=0 && !scheduleAssignments[bunk][lastIdx]) lastIdx--;
            if (lastIdx>=0) {
              const lastEntry = scheduleAssignments[bunk][lastIdx];
              // If lastEntry is not a continuation and spans into this slot, continue it
              if (lastEntry && !lastEntry.continuation) {
                const startOfSpan = lastIdx;
                // count how many slots already filled for that span
                let countSpan = 1;
                for (let k = startOfSpan+1; k < s; k++) {
                  if (scheduleAssignments[bunk][k] && scheduleAssignments[bunk][k].continuation) countSpan++;
                }
                if (countSpan < spanLen) {
                  // continue the same activity
                  scheduleAssignments[bunk][s] = { field: lastEntry.field, sport: lastEntry.sport, continuation: true, isLeague:lastEntry.isLeague||false };
                  usedFieldsThisSlot.add(lastEntry.field);
                  continued = true;
                }
              }
            }
            if (continued) continue;

            const lastEntry = (s>0) ? scheduleAssignments[bunk][s-1] : null;

            // ---- Leagues handling ----
            if (leagueSlotByDiv[div] === s && leagues[div] && leagues[div].enabled) {
              // avoid back-to-back leagues; auto-shift forward
              if (lastEntry && lastEntry.isLeague) {
                // shift to next index that is not immediately after another league for this bunk
                let t = s+1;
                while (t < times.length) {
                  const prev = scheduleAssignments[bunk][t-1];
                  if (!(prev && prev.isLeague)) break;
                  t++;
                }
                leagueSlotByDiv[div] = Math.min(t, times.length-1);
              }
              if (leagueSlotByDiv[div] === s) {
                // schedule a league game spanning spanLen
                scheduleAssignments[bunk][s] = { field: "Leagues", sport: null, continuation: false, isLeague: true };
                for (let k=1; k<spanLen && s+k<times.length; k++) {
                  scheduleAssignments[bunk][s+k] = { field: "Leagues", sport: null, continuation: true, isLeague: true };
                }
                usedFieldsThisSlot.add("Leagues");
                continue;
              }
            }

            // ---- Regular activities ----
            // Build candidates excluding fields already used in this division/time
            let candidates = allActivitiesFlat.filter(c => !usedFieldsThisSlot.has(c.field.name));

            // Exclude back-to-back same sport/field/special
            candidates = candidates.filter(c => {
              if (!lastEntry) return true;
              if (lastEntry.isLeague && c.type==="field") {
                // ok, just don't repeat same field immediately after a league (very rare)
                if (c.field.name === lastEntry.field) return false;
              }
              // prevent repeating sport back-to-back
              if (c.type==="field" && lastEntry.sport && c.sport === lastEntry.sport) return false;
              // prevent repeating same field/special back-to-back
              if (c.field.name === lastEntry.field) return false;
              return true;
            });

            // Prefer things this bunk hasn't done recently (simple fairness)
            let preferred = candidates.filter(c => !doneSets[bunk].has(c.type==="field" ? c.sport : c.field.name));
            let chosen = (preferred.length>0 ? preferred : candidates)[Math.floor(Math.random()*(preferred.length>0 ? preferred.length : candidates.length))];

            // fallback: if no candidate (e.g., all blocked), pick anything that isn't exact repeat
            if (!chosen && allActivitiesFlat.length>0) {
              let tries = allActivitiesFlat.slice();
              do {
                chosen = tries.splice(Math.floor(Math.random()*tries.length),1)[0];
              } while (chosen && lastEntry && (chosen.field.name===lastEntry.field || chosen.sport===lastEntry.sport) && tries.length>0);
            }

            if (!chosen) continue;

            // place chosen spanning spanLen
            scheduleAssignments[bunk][s] = { field: chosen.field.name, sport: chosen.sport, continuation: false, isLeague:false };
            usedFieldsThisSlot.add(chosen.field.name);
            doneSets[bunk].add(chosen.type==="field" ? chosen.sport : chosen.field.name);

            for (let k=1; k<spanLen && (s+k)<times.length; k++) {
              scheduleAssignments[bunk][s+k] = { field: chosen.field.name, sport: chosen.sport, continuation: true, isLeague:false };
            }
          }
        }
      });
    }

    // -------------------- Rendering --------------------
    function updateTable(){
      const scheduleTab = document.getElementById("schedule");
      scheduleTab.innerHTML = ""; // clear

      availableDivisions.forEach(div=>{
        const times = divisionTimes[div];
        if (!times || times.length === 0) return;

        const table = document.createElement("table");
        table.className = "division-schedule";
        const caption = document.createElement("caption");
        caption.textContent = div + " Schedule";
        table.appendChild(caption);

        // header row
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        const thTime = document.createElement("th"); thTime.textContent="Time"; headRow.appendChild(thTime);
        divisions[div].bunks.forEach(b => {
          const thB = document.createElement("th"); thB.textContent = b; thB.style.background=divisions[div].color; thB.style.color="#fff";
          headRow.appendChild(thB);
        });
        thead.appendChild(headRow); table.appendChild(thead);

        const tbody = document.createElement("tbody");

        for (let rowIdx=0; rowIdx<times.length; rowIdx++){
          const tr = document.createElement("tr");
          const tdTime = document.createElement("td"); tdTime.textContent = times[rowIdx]; tr.appendChild(tdTime);

          divisions[div].bunks.forEach(bunk=>{
            const td = document.createElement("td");
            const entry = scheduleAssignments[bunk] ? scheduleAssignments[bunk][rowIdx] : null;
            if (entry) {
              if (entry.isLeague) {
                td.innerHTML = `<span class="league-pill">Leagues</span>` + (entry.continuation ? ' <span class="continuation">→</span>' : '');
              } else if (entry.continuation) {
                td.innerHTML = `<span class="continuation">→</span>`;
              } else {
                td.textContent = entry.sport ? `${entry.field} – ${entry.sport}` : entry.field;
              }
            } else {
              td.textContent = ""; // should be rare; filled by design
            }
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        }

        table.appendChild(tbody);
        scheduleTab.appendChild(table);
      });
    }

    // -------------------- Init --------------------
    // Basic hooks
    document.getElementById("enableColor").addEventListener("change", setupDivisionButtons);
  </script>
</body>
</html>
