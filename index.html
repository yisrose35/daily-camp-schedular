<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Campistry Flow</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="design-system.css" />
    <link rel="stylesheet" href="styles.css" />
    
    <!-- ‚≠ê FIX: Hide app container initially to prevent flash -->
    <style>
        #main-app-container {
            display: none;
        }
        #auth-loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 50%, #f0fdfa 100%);
            font-family: 'Outfit', sans-serif;
        }
        .auth-loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e5e7eb;
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .auth-loading-text {
            margin-top: 16px;
            color: #374151;
            font-size: 1rem;
            font-weight: 500;
        }
        .auth-loading-subtext {
            margin-top: 4px;
            color: #6b7280;
            font-size: 0.85rem;
        }
        
        /* =============================================================== */
        /* MULTI-SCHEDULER UI STYLES */
        /* =============================================================== */
        .subdivision-status-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .subdivision-status-panel h3 {
            margin: 0 0 12px 0;
            font-size: 1rem;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .subdivision-status-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .subdivision-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .subdivision-status-item.locked {
            background: #fef3c7;
            border-color: #fcd34d;
        }
        .subdivision-status-item.locked-by-others {
            background: #fee2e2;
            border-color: #fca5a5;
        }
        .subdivision-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .subdivision-name {
            font-weight: 600;
            color: #1e293b;
        }
        .subdivision-divisions {
            font-size: 0.8rem;
            color: #64748b;
        }
        .subdivision-lock-info {
            font-size: 0.75rem;
            color: #92400e;
            margin-top: 2px;
        }
        .lock-btn {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }
        .lock-btn.can-lock {
            background: #10b981;
            color: white;
        }
        .lock-btn.can-lock:hover {
            background: #059669;
        }
        .lock-btn.can-unlock {
            background: #f59e0b;
            color: white;
        }
        .lock-btn.can-unlock:hover {
            background: #d97706;
        }
        .lock-btn.locked-other {
            background: #e5e7eb;
            color: #6b7280;
            cursor: not-allowed;
        }
        .lock-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Locked bunk indicator in schedule grid */
        .bunk-row.locked-by-other {
            opacity: 0.7;
            position: relative;
        }
        .bunk-row.locked-by-other::after {
            content: 'üîí';
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
        }
        .bunk-row.locked-by-other .cell {
            pointer-events: none;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 5px,
                rgba(0,0,0,0.03) 5px,
                rgba(0,0,0,0.03) 10px
            );
        }
    </style>
</head>
<body>

<!-- =============================================================== -->
<!-- AUTH LOADING SCREEN (Shown while checking session) -->
<!-- =============================================================== -->
<div id="auth-loading-screen">
    <div class="auth-loading-spinner"></div>
    <div class="auth-loading-text">Loading Campistry Flow</div>
    <div class="auth-loading-subtext">Checking authentication...</div>
</div>

<!-- =============================================================== -->
<!-- MAIN APP WRAPPER (Hidden until authenticated) -->
<!-- =============================================================== -->
<div id="main-app-container">
    <div class="app-shell">
        <!-- =========================================================== -->
        <!-- HEADER -->
        <!-- =========================================================== -->
        <header class="app-header">
            <div class="header-left">
                <!-- DASHBOARD LINK -->
                <a href="dashboard.html" style="color:#0D7C5C; text-decoration:none; font-weight:500; margin-right:16px;">‚Üê Dashboard</a>

                <!-- Hamburger -->
                <button id="hamburgerBtn" class="hamburger-btn" aria-label="Toggle Navigation">
                    <span></span><span></span><span></span>
                </button>
                <!-- App Title: Flow Branding -->
                <div class="app-title">
                    <div class="app-logo-icon app-logo-flow">
                        <img src="Flow.svg" alt="Flow" width="36" height="36">
                    </div>
                    <div class="app-title-text">
                        <div class="app-title-main">Campistry <span class="brand-accent-flow">Flow</span></div>
                        <div class="app-title-sub">Smart Daily Scheduling</div>
                    </div>
                </div>

                <!-- Quick Link: Campistry Me -->
                <a href="campistry_me.html" class="header-app-switch" title="Open Campistry Me ‚Äî Structure & Campers">
                    <div class="app-logo-icon app-logo-me">
                        <img src="Me.svg" alt="Me" width="30" height="30">
                    </div>
                    <span class="header-app-switch-label">Campistry <span class="brand-accent-me">Me</span></span>
                </a>
            </div>
            <div class="header-right">
                <label class="header-date-label" for="calendar-date-picker">
                    Current Schedule Date:
                </label>
                <input type="date" id="calendar-date-picker" class="header-date-input" />
            </div>
        </header>

        <!-- =========================================================== -->
        <!-- APP MAIN LAYOUT -->
        <!-- =========================================================== -->
        <div class="app-main">
            <!-- ======================================================= -->
            <!-- SIDEBAR NAVIGATION -->
            <!-- ======================================================= -->
            <aside id="sidebar" class="sidebar">
                <nav class="sidebar-nav">
                    <div class="sidebar-label">Configuration</div>
                    <button class="sidebar-item active" data-tab="setup">
                        <span class="sidebar-dot"></span> Setup (Bunks / Divisions)
                    </button>
                    <button class="sidebar-item" data-tab="locations">
                        <span class="sidebar-dot"></span> üó∫Ô∏è Location Zones
                    </button>
                    <button class="sidebar-item" data-tab="fields">
                        <span class="sidebar-dot"></span> Fields
                    </button>
                    <button class="sidebar-item" data-tab="special_activities">
                        <span class="sidebar-dot"></span> Special Activities
                    </button>
                    <button class="sidebar-item" data-tab="leagues">
                        <span class="sidebar-dot"></span> Leagues
                    </button>
                    <button class="sidebar-item" data-tab="specialty-leagues">
                        <span class="sidebar-dot"></span> üèÜ Specialty Leagues
                    </button>

                    <div class="sidebar-label" style="margin-top:12px;">Scheduling</div>
                    <button class="sidebar-item" data-tab="master-scheduler">
                        <span class="sidebar-dot"></span> üóìÔ∏è Master Scheduler
                    </button>
                    <button class="sidebar-item" data-tab="daily-adjustments">
                        <span class="sidebar-dot"></span> Daily Adjustments
                    </button>
                    <button class="sidebar-item" data-tab="schedule">
                        <span class="sidebar-dot"></span> Daily Schedule (View)
                    </button>

                    <div class="sidebar-label" style="margin-top:12px;">Output & Help</div>
                    <button class="sidebar-item" data-tab="camper-locator">
                        <span class="sidebar-dot" style="background:#0284c7;"></span> üîç Camper Check
                    </button>
                    <button class="sidebar-item" data-tab="report">
                        <span class="sidebar-dot"></span> Report
                    </button>
                    <button class="sidebar-item" data-tab="print">
                        <span class="sidebar-dot"></span> üñ®Ô∏è Print Center
                    </button>
                    <button class="sidebar-item" data-tab="updates">
                        <span class="sidebar-dot"></span> Updates
                    </button>
                    <button class="sidebar-item" data-tab="helper">
                        <span class="sidebar-dot"></span> Help & Guide
                    </button>
                </nav>
            </aside>

            <!-- BACKDROP (Mobile) -->
            <div id="sidebarBackdrop" class="sidebar-backdrop"></div>

            <!-- ======================================================= -->
            <!-- MAIN CONTENT -->
            <!-- ======================================================= -->
            <main class="app-content">

                <!-- =================================================== -->
                <!-- SETUP TAB -->
                <!-- =================================================== -->
                <div id="setup" class="tab-content active">
                    <div class="setup-grid">

                        <!-- Left Panel: Grades -->
                        <section class="setup-card">
                            <div class="setup-card-header">
                                <div class="setup-step-pill">Grades</div>
                                <div class="setup-card-text">
                                    <h3>Scheduling Grades</h3>
                                    <p>Select a grade to configure its times.</p>
                                </div>
                            </div>
                            <div id="divisionButtons" class="master-list"></div>
                        </section>

                        <!-- Right Panel: Grade Configuration -->
                        <section class="setup-card">
                            <div class="setup-card-header">
                                <div class="setup-step-pill">Times</div>
                                <div class="setup-card-text">
                                    <h3>Grade Configuration</h3>
                                    <p>Set scheduling times for the selected grade.</p>
                                </div>
                            </div>
                            <div id="division-detail-pane" class="detail-pane">
                                <p class="muted">
                                    Select a grade to configure its times and view its bunks.
                                </p>
                            </div>
                        </section>

                        <!-- Tools & Maintenance -->
                        <section class="setup-card setup-card-wide">
                            <div class="setup-card-header">
                                <div class="setup-step-pill setup-step-pill-muted">Tools</div>
                                <div class="setup-card-text">
                                    <h3>Data & Maintenance</h3>
                                    <p>Manage schedules, history & backups.</p>
                                </div>
                            </div>

                            <!-- Clear History -->
                            <div class="setup-group">
                                <h4>Clear Schedules & History</h4>
                                <p class="setup-group-help">
                                    Erase generated data without touching setup.
                                </p>
                                <div class="setup-button-row">
                                    <button id="eraseTodayBtn"
                                            style="background:#db7a00;color:#fff;border:none;"
                                            onclick="if(confirm('Delete today\'s schedule?')) window.eraseCurrentDailyData?.();">
                                        Delete ONLY Today's Schedule
                                    </button>
                                    <button id="eraseAllSchedulesBtn"
                                            style="background:#c0392b;color:#fff;border:none;"
                                            onclick="if(confirm('Delete ALL schedules for ALL days?')) window.eraseAllDailyData?.();">
                                        Delete ALL Daily Schedules
                                    </button>
                                    <button id="eraseHistoryBtn"
                                            style="background:#5e35b1;color:#fff;border:none;"
                                            onclick="
                                                if(confirm('Reset rotation history and League counters?')) {
                                                    window.eraseRotationHistory?.();
                                                    window.leagueRoundState = {};
                                                    window.saveGlobalSettings?.('leagueRoundState', {});
                                                    alert('Activity History and Game Counters reset!');
                                                }
                                            ">
                                        Reset Activity History
                                    </button>
                                    <button id="newHalfBtn"
                                            style="background:#0d9488;color:#fff;border:none;"
                                            onclick="window.startNewHalf?.();">
                                        üîÑ New Half
                                    </button>
                                </div>
                            </div>

                            <!-- Backup -->
                            <div class="setup-group">
                                <h4>Backup & Restore</h4>
                                <p class="setup-group-help">Download or upload full application data.</p>
                                <div class="setup-button-row">
                                    <button id="exportBackupBtn"
                                            style="background:#007bff;color:#fff;border:none;">
                                        Export Data to File
                                    </button>
                                    <button id="importBackupBtn"
                                            style="background:#28a745;color:#fff;border:none;">
                                        Import Data
                                    </button>
                                    <input type="file" id="importFileInput" accept=".json" style="display:none;" />
                                    <button id="restoreAutoSaveBtn"
                                            style="background:#6c757d;color:#fff;border:none;"
                                            onclick="window.restoreAutoSave?.()">
                                        Restore Last Auto-Save
                                    </button>
                                    <button id="forceSaveBtn"
                                            style="background:#17a2b8;color:#fff;border:none;"
                                            onclick="window.forceAutoSave?.()">
                                        Save Now
                                    </button>
                                </div>
                            </div>

                            <!-- Full Wipe -->
                            <div class="setup-group setup-group-danger">
                                <h4>Erase All Data</h4>
                                <p class="setup-group-help">‚ö†Ô∏è This resets EVERYTHING ‚Äì setup + schedules.</p>
                                <div class="setup-button-row">
                                    <button id="eraseAllBtn"
                                            style="background:#c0392b;color:#fff;border:none;">
                                        Erase All Camp Data
                                    </button>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
                <!-- /setup -->

                <!-- ======================================================= -->
                <!-- OTHER TABS -->
                <!-- ======================================================= -->
                <div id="locations" class="tab-content"></div>
                <div id="fields" class="tab-content"></div>
                <div id="special_activities" class="tab-content"></div>
                <div id="leagues" class="tab-content"></div>
                <div id="specialty-leagues" class="tab-content"></div>

                <div id="master-scheduler" class="tab-content">
                    <!-- ‚≠ê MULTI-SCHEDULER: Subdivision Status Panel will be inserted here -->
                    <div id="subdivision-status-container"></div>
                    <div id="master-scheduler-content"></div>
                </div>

                <div id="daily-adjustments" class="tab-content">
                    <div id="daily-adjustments-content"></div>
                </div>

                <div id="schedule" class="tab-content">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                        <h3>Daily Schedule (View)</h3>
                        <button onclick="window.validateSchedule?.()"
                            style="background:#ff9800;color:white;border:none;padding:8px 16px;border-radius:4px;font-weight:bold;">
                            ‚ö†Ô∏è Validate Schedule
                        </button>
                    </div>
                    <div id="scheduleTable"></div>
                </div>

                <div id="camper-locator" class="tab-content"></div>
                <div id="report" class="tab-content"><div id="report-content"></div></div>
                <div id="print" class="tab-content"><div id="print-content"></div></div>
                <div id="updates" class="tab-content"><div id="updates-content"></div></div>
                <div id="helper" class="tab-content"><div id="helper-content"></div></div>
            </main>
            <!-- /app-content -->
        </div>
        <!-- /app-main -->
    </div>
    <!-- /app-shell -->
</div>
<!-- /main-app-container -->

<!-- =============================================================== -->
<!-- SCRIPT LOADING (ORDER MATTERS) -->
<!-- =============================================================== -->

<!-- =============================================================== -->
<!-- CLOUD FOUNDATION (MUST LOAD FIRST) -->
<!-- =============================================================== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase_client.js"></script>
    <script src="supabase_permissions.js"></script>
<script src="supabase_schedules.js"></script>
<script src="supabase_sync.js"></script>
<script src="integration_hooks.js"></script>

    <script src="schedule_versions_db.js"></script>
<script src="global_authority.js"></script>
    <script src="cloud_sync_helpers.js"></script>
    


    

<!-- =============================================================== -->
<!-- ‚≠ê AUTH CHECK - Must run before app loads -->
<!-- =============================================================== -->
<script>
(function() {
    'use strict';
    
    const loadingScreen = document.getElementById('auth-loading-screen');
    const mainApp = document.getElementById('main-app-container');
    
    async function checkAuthAndBoot() {
        console.log("üîê Checking authentication status...");
        
        try {
            // Wait for Supabase to be ready
            let attempts = 0;
            while (!window.supabase && attempts < 20) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }
            
            if (!window.supabase) {
                console.error("üîê Supabase not available");
                redirectToLogin();
                return;
            }
            
            // Check for existing session
            const { data: { session }, error } = await window.supabase.auth.getSession();
            
            if (error) {
                console.error("üîê Session check error:", error);
                redirectToLogin();
                return;
            }
            
            if (!session) {
                console.log("üîê No active session, redirecting to login");
                redirectToLogin();
                return;
            }
            
            console.log("üîê Session found for:", session.user.email);
            
            // Update loading text
            if (loadingScreen) {
                const subtext = loadingScreen.querySelector('.auth-loading-subtext');
                if (subtext) subtext.textContent = 'Loading your camp data...';
            }
            
            // Wait for cloud hydration
            await waitForCloudHydration();
            
            // Show the app
            showApp();
            
        } catch (e) {
            console.error("üîê Auth check failed:", e);
            redirectToLogin();
        }
    }
    
    function redirectToLogin() {
        // Redirect to landing page for login
        window.location.href = 'landing.html';
    }
    
    async function waitForCloudHydration() {
        return new Promise((resolve) => {
            // Check if already ready
            if (window.__CAMPISTRY_CLOUD_READY__) {
                console.log("üîê Cloud already ready");
                resolve();
                return;
            }
            
            // Listen for hydration event
            const handler = () => {
                console.log("üîê Cloud hydration complete");
                window.removeEventListener('campistry-cloud-hydrated', handler);
                clearTimeout(timeout);
                resolve();
            };
            
            window.addEventListener('campistry-cloud-hydrated', handler);
            
            // Timeout after 5 seconds
            const timeout = setTimeout(() => {
                console.warn("üîê Cloud hydration timeout, proceeding anyway");
                window.removeEventListener('campistry-cloud-hydrated', handler);
                resolve();
            }, 5000);
        });
    }
    
    function showApp() {
        console.log("üîê Showing application");
        
        // Hide loading, show app
        if (loadingScreen) loadingScreen.style.display = 'none';
        if (mainApp) mainApp.style.display = 'block';
        
        // Mark as booted
        window.__CAMPISTRY_BOOTED__ = true;
        
        // Initialize UI components
        window.refreshGlobalRegistry?.();
        window.initCalendar?.();
        window.initApp1?.();
        window.initLeagues?.();
        window.initScheduleSystem?.();
        window.initDailyAdjustments?.();
        
        console.log("‚úÖ Campistry Flow loaded");
    }
    
    // Listen for sign out
    if (window.supabase) {
        window.supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                console.log("üîê User signed out, redirecting...");
                redirectToLogin();
            }
        });
    }
    
    // Start auth check when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', checkAuthAndBoot);
    } else {
        // Small delay to ensure Supabase is initialized
        setTimeout(checkAuthAndBoot, 100);
    }
})();
</script>

<!-- =============================================================== -->
<!-- CORE APP -->
<!-- =============================================================== -->
<script src="welcome.js"></script>
<script src="calendar.js"></script>
   
<script src="app1.js"></script>
<script src="locations.js"></script>
<script src="skeleton_sandbox.js"></script>
<script src="daily_adjustments.js"></script>
<script src="rainy_day_manager.js"></script>
<script src="special_activities.js"></script>
<script src="fields.js"></script>
<script src="leagues.js"></script>
<script src="specialty_leagues.js"></script>
<script src="master_schedule_builder.js"></script>
<script src="smart_logic_adapter.js"></script>
    
    <!-- =============================================================== -->
<!-- ‚≠ê NEW: PERMISSIONS & VERSIONING SYSTEM -->
<!-- =============================================================== -->
<script src="permissions_guard.js"></script>


<!-- =============================================================== -->
<!-- ‚≠ê RBAC & MULTI-SCHEDULER SYSTEM (LOAD BEFORE SCHEDULER CORE) -->
<!-- =============================================================== -->
<script src="access_control.js"></script>
<script src="subdivision_schedule_manager.js"></script>


<script src="rbac_init.js"></script>
    
<script src="division_times_system.js"></script>
<script src="division_times_integration.js"></script>
<!-- =============================================================== -->
<!-- SCHEDULER CORE -->
<!-- =============================================================== -->
<script src="scheduler_core_loader.js"></script>
<script src="global_field_locks.js"></script>
<script src="scheduler_core_utils.js"></script>
<script src="rotation_engine.js"></script>
<script src="total_solver_engine.js"></script>
<script src="scheduler_core_specialty_leagues.js"></script>
<script src="scheduler_core_leagues.js"></script>
<script src="scheduler_logic_fillers.js"></script>
<script src="scheduler_core_main.js"></script>
<script src="schedule_orchestrator.js"></script>

    <!-- UNIFIED SCHEDULE SYSTEM (add after scheduler_core files) -->
<script src="unified_schedule_system.js"></script>
   <script src="post_edit_system.js"></script>
    


<!-- NEW: Pinned preservation (must come after scheduler_core_main.js) -->
<script src="pinned_activity_preservation.js"></script>

    
    

<!-- =============================================================== -->
<!-- OUTPUT / HELP -->
<!-- =============================================================== -->
<script src="analytics.js"></script>
<script src="camper_locator.js"></script>
<script src="validator.js"></script>
<script src="print_center.js"></script>
<script src="helper.js"></script>
<script src="updates.js"></script>
    


<!-- =============================================================== -->
<!-- TAB NAVIGATION & SIDEBAR HANDLING -->
<!-- =============================================================== -->
<script>
/* TAB SWITCHING */
function showTab(id) {
    document.querySelectorAll(".tab-content").forEach(el =>
        el.classList.remove("active")
    );
    document.getElementById(id)?.classList.add("active");
    document.querySelectorAll(".sidebar-item").forEach(btn =>
        btn.classList.toggle("active", btn.dataset.tab === id)
    );

    if (id === "setup") window.initApp1?.();
    if (id === "locations") window.initLocationsTab?.();
    if (id === "fields") window.initFieldsTab?.();
    if (id === "special_activities") window.initSpecialActivitiesTab?.();
    if (id === "leagues") window.initLeagues?.();
    if (id === "specialty-leagues") window.initSpecialtyLeagues?.();
    if (id === "master-scheduler") {
        window.initMasterScheduler?.();
        // ‚≠ê MULTI-SCHEDULER: Render subdivision status panel
        const container = document.getElementById('subdivision-status-container');
        if (container) {
            window.SchedulerSubdivisionIntegration?.createSubdivisionStatusPanel?.(container);
        }
    }
    if (id === "daily-adjustments") window.initDailyAdjustments?.();
    if (id === "schedule") window.updateTable?.();
    if (id === "camper-locator") window.initCamperLocator?.();
    if (id === "report") window.initReportTab?.();
    if (id === "print") window.initPrintCenter?.();
    if (id === "updates") window.initUpdatesTab?.();
    if (id === "helper") window.initHelperTab?.();
}

/* SIDEBAR (Mobile) */
(function () {
    const hamburger = document.getElementById("hamburgerBtn");
    const sidebar = document.getElementById("sidebar");
    const backdrop = document.getElementById("sidebarBackdrop");

    hamburger?.addEventListener("click", () =>
        document.body.classList.toggle("sidebar-open")
    );
    backdrop?.addEventListener("click", () =>
        document.body.classList.remove("sidebar-open")
    );

    sidebar?.querySelectorAll(".sidebar-item").forEach(btn => {
        btn.addEventListener("click", () => {
            showTab(btn.dataset.tab);
            document.body.classList.remove("sidebar-open");
        });
    });
})();
</script>
</body>
</html>
