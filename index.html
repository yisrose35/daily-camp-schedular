<!DOCTYPE html>
<html>
<head>
  <title>Camp Scheduler</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .tabs { margin-bottom: 20px; }
    .tab-button { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; background: #f0f0f0; margin-right: 5px; }
    .tab-button.active { background: #007BFF; color: white; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid black; padding: 8px; text-align: center; min-width: 140px; }

    .bunk-button { margin: 2px; padding: 5px 10px; cursor: pointer; border: 1px solid #333; border-radius: 4px; display: inline-block; }
    .selected { outline: 3px solid #90CAF9; }
    #unassignedBunks { margin-top: 10px; }
    .divisionWrapper { display: inline-block; margin-right: 10px; }
    .colorPicker { width: 30px; height: 30px; border: none; cursor: pointer; vertical-align: middle; margin-left: 6px; }

    .fieldWrapper { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 6px; }
    .fieldWrapper.unavailable { opacity: 0.5; }
    .fieldTitle { font-weight: 600; margin-right: 10px; cursor: pointer; }

    .activity-button { margin: 2px; padding: 4px 8px; border: 1px solid #333; border-radius: 3px; cursor: pointer; }
    .activity-button.active { background: #007BFF; color: white; }

    .switch { position: relative; display: inline-block; width: 40px; height: 20px; vertical-align: middle; margin-left: 8px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
      background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #4CAF50; }
    input:checked + .slider:before { transform: translateX(20px); }
  </style>
</head>
<body>
  <h1>Camp Scheduler</h1>

  <div class="tabs">
    <button class="tab-button active" onclick="showTab('setup')">Setup & Configuration</button>
    <button class="tab-button" onclick="showTab('schedule')">Daily Schedule</button>
  </div>

  <!-- Setup Tab -->
  <div id="setup" class="tab-content active">
    <h3>Add Bunks</h3>
    <input id="bunkInput" placeholder="Enter bunk">
    <button id="addBunkBtn">Add Bunk</button>
    <div id="unassignedBunks"></div>

    <h3>Add Divisions</h3>
    <input id="divisionInput" placeholder="Enter division name">
    <button id="addDivisionBtn">Add Division</button>
    <label style="margin-left:8px;"><input type="checkbox" id="enableColor" checked> Enable colors</label>
    <div id="divisionButtons" style="margin-top:8px;"></div>

    <h3>Generate Times</h3>
    Start: <input type="text" id="startTime" placeholder="e.g., 11:30 AM">
    End: <input type="text" id="endTime" placeholder="e.g., 5:30 PM">
    Increment:
    <select id="increment">
      <option value="15">15 min</option>
      <option value="30">30 min</option>
      <option value="45">45 min</option>
      <option value="60">60 min</option>
    </select>
    <button onclick="generateTimes()">Generate</button>

    <h3>Add Fields/Courts</h3>
    <input id="fieldInput" placeholder="Enter field/court name (e.g., Court #1)">
    <button id="addFieldBtn">Add Field/Court</button>
    <div id="fieldList"></div>

    <h3>Add Special Activities</h3>
    <input id="specialInput" placeholder="Enter special activity (e.g., Canteen)">
    <button id="addSpecialBtn">Add Special Activity</button>
    <div id="specialList"></div>
  </div>

  <!-- Schedule Tab -->
  <div id="schedule" class="tab-content">
    <table id="scheduleTable" style="display:none;">
      <thead>
        <tr id="divisionRow"></tr>
        <tr id="bunkRow"></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let bunks = [], divisions = {}, availableDivisions = [], selectedDivision = null;
    let times = [], fields = [], specialActivities = [], scheduleAssignments = {};
    const defaultColors = ['#4CAF50','#2196F3','#E91E63','#FF9800','#9C27B0','#00BCD4','#FFC107','#F44336','#8BC34A','#3F51B5'];
    let colorIndex = 0;
    const commonActivities = ["Basketball","Baseball","Hockey","Football","Soccer","Volleyball","Lacrosse"];

    function makeEditable(el, save){
      el.ondblclick = e => {
        e.stopPropagation();
        const old = el.textContent;
        const input = document.createElement("input");
        input.type="text"; input.value=old;
        el.replaceWith(input); input.focus();
        function done(){
          const val=input.value.trim();
          if(val&&val!==old) save(val);
          el.textContent=val||old; input.replaceWith(el);
        }
        input.onblur=done; input.onkeyup=e=>{if(e.key==="Enter")done();};
      };
    }

    function showTab(id){
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`.tab-button[onclick="showTab('${id}')"]`).classList.add('active');
      if(id==='schedule') updateTable();
    }

    function addBunk(){
      const input=document.getElementById("bunkInput");
      if(input.value.trim()!==""){
        bunks.push(input.value.trim());
        input.value=""; updateUnassigned(); updateTable();
      }
    }
    document.getElementById("addBunkBtn").onclick=addBunk;
    document.getElementById("bunkInput").addEventListener("keyup",e=>{if(e.key==="Enter")addBunk();});

    function updateUnassigned(){
      const container=document.getElementById("unassignedBunks");
      container.innerHTML="";
      bunks.forEach(bunk=>{
        const span=document.createElement("span");
        span.textContent=bunk;
        span.className="bunk-button";

        let assignedDiv=null;
        for(const divName in divisions){
          if(divisions[divName].bunks.includes(bunk)){assignedDiv=divName; break;}
        }

        if(assignedDiv){
          const divColor=divisions[assignedDiv].color;
          span.style.backgroundColor=divColor;
          span.style.color="#fff";
        }

        span.onclick=()=>{
          if(selectedDivision && (!assignedDiv || assignedDiv!==selectedDivision)){
            for(const divName in divisions){
              const i=divisions[divName].bunks.indexOf(bunk);
              if(i!==-1) divisions[divName].bunks.splice(i,1);
            }
            divisions[selectedDivision].bunks.push(bunk);
            updateUnassigned(); updateTable();
          } else if(!selectedDivision){
            alert("Select a division first!");
          }
        };

        makeEditable(span,newName=>{
          const idx=bunks.indexOf(bunk);
          if(idx!==-1) bunks[idx]=newName;
          for(const div of Object.values(divisions)){
            const i=div.bunks.indexOf(bunk);
            if(i!==-1) div.bunks[i]=newName;
          }
          updateUnassigned(); updateTable();
        });

        container.appendChild(span);
      });
    }

    function addDivision(){
      const input=document.getElementById("divisionInput");
      if(input.value.trim()==="")return;
      const name=input.value.trim();
      if(!availableDivisions.includes(name)){
        const color=defaultColors[colorIndex%defaultColors.length]; colorIndex++;
        availableDivisions.push(name);
        divisions[name]={bunks:[],color:color};
        input.value=""; setupDivisionButtons(); updateTable();
      }
    }
    document.getElementById("addDivisionBtn").onclick=addDivision;
    document.getElementById("divisionInput").addEventListener("keyup",e=>{if(e.key==="Enter")addDivision();});

    function setupDivisionButtons(){
      const cont=document.getElementById("divisionButtons"); cont.innerHTML="";
      const colorEnabled=document.getElementById("enableColor").checked;
      availableDivisions.forEach(name=>{
        const obj=divisions[name];
        const wrap=document.createElement("div"); wrap.className="divisionWrapper";
        const span=document.createElement("span"); span.textContent=name; span.className="bunk-button";
        span.style.backgroundColor=colorEnabled?obj.color:"transparent";
        span.style.color=colorEnabled?"#fff":"inherit";
        span.onclick=()=>{selectedDivision=name; cont.querySelectorAll('span.bunk-button').forEach(el=>el.classList.remove("selected")); span.classList.add("selected");};
        makeEditable(span,newName=>{
          divisions[newName]=divisions[name]; delete divisions[name];
          availableDivisions[availableDivisions.indexOf(name)]=newName;
          if(selectedDivision===name)selectedDivision=newName;
          setupDivisionButtons(); updateTable();
        });
        wrap.appendChild(span);
        const col=document.createElement("input"); col.type="color"; col.value=obj.color; col.className="colorPicker";
        col.oninput=e=>{obj.color=e.target.value; if(colorEnabled){span.style.backgroundColor=e.target.value; span.style.color="#fff";} updateTable();};
        wrap.appendChild(col); cont.appendChild(wrap);
      });
    }

    function generateTimes(){
      const startStr=document.getElementById("startTime").value.trim();
      const endStr=document.getElementById("endTime").value.trim();
      const inc=parseInt(document.getElementById("increment").value);

      function parseTime(str){
        str = str.trim();
        const m=str.match(/^(\d{1,2}):(\d{2})(\s*)?(AM|PM)$/i);
        if(!m) return null;
        let h=parseInt(m[1],10), min=parseInt(m[2],10), ampm=m[4].toUpperCase();
        if(ampm==="PM"&&h!==12)h+=12;
        if(ampm==="AM"&&h===12)h=0;
        return new Date(0,0,0,h,min);
      }

      const start=parseTime(startStr), end=parseTime(endStr);
      if(!start||!end||start>=end){alert("Enter valid times like 11:30 AM and 5:30 PM."); return;}
      times=[]; let cur=new Date(start);
      function fmt(d){let h=d.getHours(),m=d.getMinutes().toString().padStart(2,"0"),ap=h>=12?"PM":"AM"; h=h%12||12; return `${h}:${m} ${ap}`;}
      while(cur<end){let nxt=new Date(cur.getTime()+inc*60000); if(nxt>end)nxt=end; times.push(`${fmt(cur)} - ${fmt(nxt)}`); cur=nxt;}
      assignFieldsToBunks(); updateTable();
    }
    document.getElementById("startTime").addEventListener("keyup",e=>{if(e.key==="Enter")document.getElementById("endTime").focus();});

    function addField(){
      const input=document.getElementById("fieldInput");
      const name=input.value.trim();
      if(name){fields.push({name:name,activities:[],available:true}); input.value=""; renderFields();}
    }
    document.getElementById("addFieldBtn").onclick=addField;
    document.getElementById("fieldInput").addEventListener("keyup",e=>{if(e.key==="Enter")addField();});

    function renderFields(){
      const cont=document.getElementById("fieldList"); cont.innerHTML="";
      fields.forEach(field=>{
        const wrap=document.createElement("div"); wrap.className="fieldWrapper"; if(!field.available)wrap.classList.add("unavailable");
        const title=document.createElement("span"); title.className="fieldTitle"; title.textContent=field.name;
        makeEditable(title,newName=>{field.name=newName; renderFields();}); wrap.appendChild(title);
        const toggle=document.createElement("label"); toggle.className="switch";
        const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=field.available;
        cb.onchange=()=>{field.available=cb.checked; renderFields();};
        const slider=document.createElement("span"); slider.className="slider";
        toggle.appendChild(cb); toggle.appendChild(slider); wrap.appendChild(toggle);
        const btnWrap=document.createElement("div"); btnWrap.style.marginTop="8px";
        commonActivities.forEach(act=>{
          const btn=document.createElement("button"); btn.textContent=act; btn.className="activity-button";
          if(field.activities.includes(act))btn.classList.add("active");
          btn.onclick=()=>{if(field.activities.includes(act))field.activities=field.activities.filter(a=>a!==act); else field.activities.push(act); renderFields();};
          btnWrap.appendChild(btn);
        }); wrap.appendChild(btnWrap);
        const other=document.createElement("input"); other.placeholder="Other activity";
        other.onkeyup=e=>{if(e.key==="Enter"&&other.value.trim()){const v=other.value.trim(); if(!field.activities.includes(v))field.activities.push(v); other.value=""; renderFields();}};
        wrap.appendChild(other);
        if(field.activities.length>0){const p=document.createElement("p"); p.style.marginTop="6px"; p.textContent="Activities: "+field.activities.join(", "); wrap.appendChild(p);}
        cont.appendChild(wrap);
      });
    }

    // --- Special Activities ---
    function addSpecial(){
      const input=document.getElementById("specialInput");
      const name=input.value.trim();
      if(name){specialActivities.push({name:name,available:true}); input.value=""; renderSpecials();}
    }
    document.getElementById("addSpecialBtn").onclick=addSpecial;
    document.getElementById("specialInput").addEventListener("keyup",e=>{if(e.key==="Enter")addSpecial();});

    function renderSpecials(){
      const cont=document.getElementById("specialList"); cont.innerHTML="";
      specialActivities.forEach(act=>{
        const wrap=document.createElement("div"); wrap.className="fieldWrapper"; if(!act.available)wrap.classList.add("unavailable");
        const title=document.createElement("span"); title.className="fieldTitle"; title.textContent=act.name;
        makeEditable(title,newName=>{act.name=newName; renderSpecials();}); wrap.appendChild(title);
        const toggle=document.createElement("label"); toggle.className="switch";
        const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=act.available;
        cb.onchange=()=>{act.available=cb.checked; renderSpecials();};
        const slider=document.createElement("span"); slider.className="slider";
        toggle.appendChild(cb); toggle.appendChild(slider); wrap.appendChild(toggle);
        cont.appendChild(wrap);
      });
    }

    // --- Assignment Logic ---
    function assignFieldsToBunks() {
      const scheduled = availableDivisions.flatMap(div => divisions[div].bunks);
      const availFields = fields.filter(f => f.available);

      if (scheduled.length === 0 || times.length === 0) { scheduleAssignments = {}; return; }
      if (availFields.length < scheduled.length) { alert("Not enough fields for bunks."); scheduleAssignments = {}; return; }

      scheduleAssignments = {};
      let bunkSportCounts = {};
      scheduled.forEach(b => { scheduleAssignments[b] = []; bunkSportCounts[b] = {}; });

      for (let s = 0; s < times.length; s++) {
        let usedFields = new Set();

        for (let bunk of scheduled) {
          let lastSport = s > 0 ? scheduleAssignments[bunk][s-1].sport : null;
          let candidates = [];

          for (let f of availFields) {
            if (usedFields.has(f.name)) continue;
            for (let act of f.activities) {
              candidates.push({ field: f, sport: act });
            }
          }

          let validChoices = candidates.filter(c => c.sport !== lastSport);
          let chosen;
          if (validChoices.length > 0) {
            let minCount = Math.min(...validChoices.map(c => bunkSportCounts[bunk][c.sport] || 0));
            let bestChoices = validChoices.filter(c => (bunkSportCounts[bunk][c.sport] || 0) === minCount);
            chosen = bestChoices[Math.floor(Math.random() * bestChoices.length)];
          } else if (candidates.length > 0) {
            let minCount = Math.min(...candidates.map(c => bunkSportCounts[bunk][c.sport] || 0));
            let bestChoices = candidates.filter(c => (bunkSportCounts[bunk][c.sport] || 0) === minCount);
            chosen = bestChoices[Math.floor(Math.random() * bestChoices.length)];
          } else {
            chosen = { field: availFields[0], sport: availFields[0]?.activities[0] || "" };
          }

          usedFields.add(chosen.field.name);
          scheduleAssignments[bunk].push({ field: chosen.field.name, sport: chosen.sport });
          bunkSportCounts[bunk][chosen.sport] = (bunkSportCounts[bunk][chosen.sport] || 0) + 1;
        }
      }
    }

    function updateTable(){
      const table=document.getElementById("scheduleTable");
      if(times.length===0){table.style.display="none"; return;} table.style.display="table";
      const divRow=document.getElementById("divisionRow"), bunkRow=document.getElementById("bunkRow");
      divRow.innerHTML="<th>Division</th>"; bunkRow.innerHTML="<th>Bunk</th>";
      availableDivisions.forEach(div=>{
        const obj=divisions[div]; const bunksInDiv=obj.bunks;
        const th=document.createElement("th"); th.colSpan=Math.max(bunksInDiv.length,1); th.textContent=div; divRow.appendChild(th);
        bunksInDiv.forEach(bunk=>{const thB=document.createElement("th"); thB.textContent=bunk; bunkRow.appendChild(thB);});
      });
      const tbody=document.querySelector("#scheduleTable tbody"); tbody.innerHTML="";
      times.forEach((time,rowIdx)=>{
        const row=document.createElement("tr"); const tdTime=document.createElement("td"); tdTime.textContent=time; row.appendChild(tdTime);
        availableDivisions.forEach(div=>{
          divisions[div].bunks.forEach(bunk=>{
            const td=document.createElement("td");
            if(scheduleAssignments[bunk]&&scheduleAssignments[bunk][rowIdx]){
              const entry=scheduleAssignments[bunk][rowIdx];
              td.textContent=entry.field+(entry.sport?" â€“ "+entry.sport:"");
            }
            row.appendChild(td);
          });
        });
        tbody.appendChild(row);
      });
    }
  </script>
</body>
</html>
