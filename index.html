<!DOCTYPE html>
<html>
<head>
  <title>Camp Scheduler</title>
  <meta charset="utf-8" />
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .tabs { margin-bottom: 20px; }
    .tab-button { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; background: #f0f0f0; margin-right: 5px; }
    .tab-button.active { background: #007BFF; color: white; font-weight: bold; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid black; padding: 8px; text-align: center; min-width: 120px; }
    caption { font-weight: bold; margin: 10px 0; }

    .bunk-button { margin: 2px; padding: 5px 10px; cursor: pointer; border: 1px solid #333; border-radius: 4px; display: inline-block; }
    .selected { outline: 3px solid #90CAF9; }
    #unassignedBunks { margin-top: 10px; }
    .divisionWrapper { display: inline-block; margin: 6px; padding: 6px; border: 1px dashed #ccc; border-radius: 6px; }
    .colorPicker { width: 30px; height: 30px; border: none; cursor: pointer; vertical-align: middle; margin-left: 6px; }

    .fieldWrapper { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 6px; }
    .fieldWrapper.unavailable { opacity: 0.5; }
    .fieldTitle { font-weight: 600; margin-right: 10px; cursor: pointer; }

    .activity-button { margin: 2px; padding: 4px 8px; border: 1px solid #333; border-radius: 3px; cursor: pointer; }
    .activity-button.active { background: #007BFF; color: white; }

    .switch { position: relative; display: inline-block; width: 40px; height: 20px; vertical-align: middle; margin-left: 8px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc; transition: .4s; border-radius: 20px; }
    .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
      background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #4CAF50; }
    input:checked + .slider:before { transform: translateX(20px); }

    .continuation { opacity: 0.7; font-style: italic; }
    .league-pill { background:#4CAF50; color:#fff; padding:2px 6px; border-radius:12px; }
    .grey-cell { background:#eee; }
  </style>
</head>
<body>
  <h1>Camp Scheduler</h1>

  <div class="tabs">
    <button class="tab-button active" onclick="showTab('setup')">Setup & Configuration</button>
    <button class="tab-button" onclick="showTab('schedule')">Daily Schedule</button>
    <button class="tab-button" onclick="showTab('leagues')">Leagues</button>
  </div>

  <!-- Setup Tab -->
  <div id="setup" class="tab-content active">
    <h3>Add Bunks</h3>
    <input id="bunkInput" placeholder="Enter bunk">
    <button id="addBunkBtn">Add Bunk</button>
    <div id="unassignedBunks"></div>

    <h3>Add Divisions</h3>
    <input id="divisionInput" placeholder="Enter division name">
    <button id="addDivisionBtn">Add Division</button>
    <label style="margin-left:8px;"><input type="checkbox" id="enableColor" checked> Enable colors</label>
    <div id="divisionButtons" style="margin-top:8px;"></div>

    <h3>Schedule Increments</h3>
    <select id="increment">
      <option value="15">15 minutes</option>
      <option value="30" selected>30 minutes</option>
      <option value="45">45 minutes</option>
      <option value="60">60 minutes</option>
    </select>

    <h3>Activity Duration</h3>
    <select id="activityDuration">
      <option value="15">15 minutes</option>
      <option value="30" selected>30 minutes</option>
      <option value="45">45 minutes</option>
      <option value="60">60 minutes</option>
      <option value="90">90 minutes</option>
    </select>

    <h3>Division Time Templates</h3>
    <input id="timeStartInput" placeholder="Start (e.g. 11:00 AM)">
    <input id="timeEndInput" placeholder="End (e.g. 4:30 PM)">
    <button onclick="addTimeTemplate()">Add Time</button>
    <div id="timeTemplates"></div>

    <button style="margin-top:10px;" onclick="generateTimes()">Generate Schedule Times</button>

    <h3>Add Fields/Courts</h3>
    <input id="fieldInput" placeholder="Enter field/court name (e.g., Court #1)">
    <button id="addFieldBtn">Add Field/Court</button>
    <div id="fieldList"></div>

    <h3>Add Special Activities</h3>
    <input id="specialInput" placeholder="Enter special activity (e.g., Canteen)">
    <button id="addSpecialBtn">Add Special Activity</button>
    <div id="specialList"></div>
  </div>

  <!-- Schedule Tab -->
  <div id="schedule" class="tab-content"></div>

  <!-- Leagues Tab -->
  <div id="leagues" class="tab-content">
    <h3>Leagues Setup</h3>
    <div id="leaguesContainer"></div>
  </div>

  <script>
    // -------------------- State --------------------
    let bunks = [];
    let divisions = {};  // { divName:{ bunks:[], color, start, end } }
    let availableDivisions = [];
    let selectedDivision = null;

    let fields = [], specialActivities = [];
    let leagues = {};    // { divName:{enabled:boolean, sports:string[]} }

    let timeTemplates = []; // [{start,end,divisions:[]}]
    let activityDuration = 30;
    let scheduleAssignments = {}; // { bunkName: [ per unified row index: {field,sport,continuation,isLeague,_skip} ] }
    let unifiedTimes = []; // [{start:Date,end:Date,label:string}]
    let divisionActiveRows = {}; // { divName: Set(rowIndices) }

    const defaultColors = ['#4CAF50','#2196F3','#E91E63','#FF9800','#9C27B0','#00BCD4','#FFC107','#F44336','#8BC34A','#3F51B5'];
    let colorIndex=0;
    const commonActivities=["Basketball","Baseball","Hockey","Football","Soccer","Volleyball","Lacrosse"];
    const leagueSports=["Basketball","Hockey","Volleyball","Soccer","Kickball","Punchball","Baseball"];

    document.getElementById("activityDuration").onchange=function(){activityDuration=parseInt(this.value);};

    // -------------------- Helpers --------------------
    function makeEditable(el, save){
      el.ondblclick=e=>{
        e.stopPropagation();
        const old=el.textContent;
        const input=document.createElement("input");
        input.type="text"; input.value=old;
        el.replaceWith(input); input.focus();
        function done(){
          const val=input.value.trim();
          if(val&&val!==old) save(val);
          el.textContent=val||old; input.replaceWith(el);
        }
        input.onblur=done; input.onkeyup=e=>{if(e.key==="Enter")done();};
      };
    }
    function parseTime(str){
      if(!str) return null;
      const m=str.match(/^(\d{1,2}):(\d{2})(\s*)?(AM|PM)$/i);
      if(!m) return null;
      let h=parseInt(m[1],10), min=parseInt(m[2],10), ap=m[4].toUpperCase();
      if(ap==="PM"&&h!==12)h+=12; if(ap==="AM"&&h===12)h=0;
      return new Date(0,0,0,h,min);
    }
    function fmtTime(d){
      let h=d.getHours(),m=d.getMinutes().toString().padStart(2,"0"),ap=h>=12?"PM":"AM";h=h%12||12;
      return `${h}:${m} ${ap}`;
    }

    // -------------------- Tabs --------------------
    function showTab(id){
      document.querySelectorAll('.tab-button').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`.tab-button[onclick="showTab('${id}')"]`).classList.add('active');
      if(id==='schedule') updateTable();
      if(id==='leagues') renderLeagues();
    }

    // -------------------- Bunks --------------------
    function addBunk(){
      const i=document.getElementById("bunkInput");
      if(i.value.trim()!==""){
        bunks.push(i.value.trim());
        i.value="";
        updateUnassigned(); updateTable();
      }
    }
    document.getElementById("addBunkBtn").onclick=addBunk;
    document.getElementById("bunkInput").addEventListener("keyup",e=>{if(e.key==="Enter")addBunk();});

    function updateUnassigned(){
      const c=document.getElementById("unassignedBunks");c.innerHTML="";
      bunks.forEach(b=>{
        const span=document.createElement("span");
        span.textContent=b;span.className="bunk-button";
        let assigned=null;
        for(const d in divisions){ if(divisions[d].bunks.includes(b)) assigned=d; }
        if(assigned){span.style.backgroundColor=divisions[assigned].color;span.style.color="#fff";}
        span.onclick=()=>{
          if(selectedDivision && (!assigned||assigned!==selectedDivision)){
            for(const d in divisions){const i=divisions[d].bunks.indexOf(b);if(i!==-1)divisions[d].bunks.splice(i,1);}
            divisions[selectedDivision].bunks.push(b);updateUnassigned();updateTable();
          }else if(!selectedDivision){ alert("Select a division first!"); }
        };
        makeEditable(span,newName=>{
          const idx=bunks.indexOf(b);if(idx!==-1)bunks[idx]=newName;
          for(const d of Object.values(divisions)){const i=d.bunks.indexOf(b);if(i!==-1)d.bunks[i]=newName;}
          // Move schedule assignments to new key if any
          if(scheduleAssignments[b]){ scheduleAssignments[newName]=scheduleAssignments[b]; delete scheduleAssignments[b]; }
          updateUnassigned();updateTable();
        });
        c.appendChild(span);
      });
    }

    // -------------------- Divisions --------------------
    function addDivision(){
      const i=document.getElementById("divisionInput");
      if(i.value.trim()==="")return;
      const name=i.value.trim();
      if(!availableDivisions.includes(name)){
        const color=defaultColors[colorIndex%defaultColors.length]; colorIndex++;
        availableDivisions.push(name);
        divisions[name]={bunks:[],color,start:null,end:null};
        leagues[name]={enabled:false,sports:[]};
        i.value="";
        setupDivisionButtons(); renderLeagues(); updateTable();
        renderTimeTemplates(); // refresh template assignment UI
      }
    }
    document.getElementById("addDivisionBtn").onclick=addDivision;
    document.getElementById("divisionInput").addEventListener("keyup",e=>{if(e.key==="Enter")addDivision();});

    function setupDivisionButtons(){
      const cont=document.getElementById("divisionButtons"); cont.innerHTML="";
      const colorEnabled=document.getElementById("enableColor").checked;
      availableDivisions.forEach(name=>{
        const obj=divisions[name];
        const wrap=document.createElement("div"); wrap.className="divisionWrapper";
        const span=document.createElement("span"); span.textContent=name; span.className="bunk-button";
        span.style.backgroundColor=colorEnabled?obj.color:"transparent";
        span.style.color=colorEnabled?"#fff":"inherit";
        span.onclick=()=>{selectedDivision=name; cont.querySelectorAll('span.bunk-button').forEach(el=>el.classList.remove("selected")); span.classList.add("selected");};
        makeEditable(span,newName=>{
          divisions[newName]=divisions[name]; delete divisions[name];
          leagues[newName]=leagues[name]||{enabled:false,sports:[]}; delete leagues[name];
          availableDivisions[availableDivisions.indexOf(name)]=newName;
          if(selectedDivision===name)selectedDivision=newName;
          setupDivisionButtons(); renderLeagues(); renderTimeTemplates(); updateTable();
        });
        wrap.appendChild(span);
        const col=document.createElement("input"); col.type="color"; col.value=obj.color; col.className="colorPicker";
        col.oninput=e=>{obj.color=e.target.value; if(colorEnabled){span.style.backgroundColor=e.target.value; span.style.color="#fff";} updateTable(); renderTimeTemplates();};
        wrap.appendChild(col);
        cont.appendChild(wrap);
      });
    }
    document.getElementById("enableColor").addEventListener("change", setupDivisionButtons);

    // -------------------- Time Templates --------------------
    function addTimeTemplate(){
      const start=document.getElementById("timeStartInput").value.trim();
      const end=document.getElementById("timeEndInput").value.trim();
      if(!start||!end) return;
      timeTemplates.push({start,end,divisions:[]});
      document.getElementById("timeStartInput").value="";
      document.getElementById("timeEndInput").value="";
      renderTimeTemplates();
    }

    function renderTimeTemplates(){
      const cont=document.getElementById("timeTemplates"); cont.innerHTML="";
      timeTemplates.forEach((tpl,idx)=>{
        const wrap=document.createElement("div"); wrap.className="fieldWrapper";
        const label=document.createElement("span"); label.textContent=`${tpl.start} - ${tpl.end}`;
        wrap.appendChild(label);

        availableDivisions.forEach(div=>{
          const btn=document.createElement("button");
          btn.textContent=div; btn.className="bunk-button";
          if(tpl.divisions.includes(div)){ btn.style.backgroundColor=divisions[div].color; btn.style.color="#fff"; }
          else { btn.style.backgroundColor="#fff"; btn.style.color="#000"; }
          btn.onclick=()=>{
            if(tpl.divisions.includes(div)){
              tpl.divisions = tpl.divisions.filter(d=>d!==div);
            } else {
              tpl.divisions.push(div);
            }
            // Apply latest picks immediately
            applyTemplatesToDivisions();
            renderTimeTemplates();
          };
          wrap.appendChild(btn);
        });

        cont.appendChild(wrap);
      });

      // Apply when first rendered (covers color toggles etc.)
      applyTemplatesToDivisions();
    }

    function applyTemplatesToDivisions(){
      // A division can be in at most one template; last template containing it wins
      availableDivisions.forEach(div=>{
        let match = null;
        for(let i=timeTemplates.length-1;i>=0;i--){
          if(timeTemplates[i].divisions.includes(div)){ match=timeTemplates[i]; break; }
        }
        if(match){ divisions[div].start=match.start; divisions[div].end=match.end; }
      });
    }

    // -------------------- Generate Times (Unified Grid) --------------------
    function generateTimes(){
      // Build unifiedTimes from overall earliest start to latest end across all divisions with times
      const inc = parseInt(document.getElementById("increment").value);

      // ensure templates are applied
      applyTemplatesToDivisions();

      const starts = availableDivisions.map(d=>parseTime(divisions[d].start)).filter(Boolean);
      const ends   = availableDivisions.map(d=>parseTime(divisions[d].end)).filter(Boolean);
      if(starts.length===0 || ends.length===0){ alert("Please set time templates for divisions first."); return; }

      const earliest = new Date(Math.min(...starts.map(d=>d.getTime())));
      const latest   = new Date(Math.max(...ends.map(d=>d.getTime())));
      unifiedTimes = [];
      let cur = new Date(earliest);
      while(cur < latest){
        let nxt = new Date(cur.getTime() + inc*60000);
        if(nxt > latest) nxt = latest;
        unifiedTimes.push({ start:new Date(cur), end:new Date(nxt), label:`${fmtTime(cur)} - ${fmtTime(nxt)}` });
        cur = nxt;
      }

      // Compute active rows per division
      divisionActiveRows = {};
      availableDivisions.forEach(div=>{
        const s=parseTime(divisions[div].start), e=parseTime(divisions[div].end);
        const rows = new Set();
        unifiedTimes.forEach((t,idx)=>{
          if (s && e && t.start >= s && t.start < e) rows.add(idx);
        });
        divisionActiveRows[div] = rows;
      });

      assignFieldsToBunks();
      updateTable();
    }

    // -------------------- Fields / Specials --------------------
    function addField(){
      const i=document.getElementById("fieldInput"); const n=i.value.trim();
      if(n){fields.push({name:n,activities:[],available:true});i.value="";renderFields();}
    }
    document.getElementById("addFieldBtn").onclick=addField;
    document.getElementById("fieldInput").addEventListener("keyup",e=>{if(e.key==="Enter")addField();});

    function renderFields(){
      const c=document.getElementById("fieldList"); c.innerHTML="";
      fields.forEach(f=>{
        const w=document.createElement("div"); w.className="fieldWrapper"; if(!f.available)w.classList.add("unavailable");
        const t=document.createElement("span"); t.className="fieldTitle"; t.textContent=f.name;
        makeEditable(t,newName=>{f.name=newName;renderFields();}); w.appendChild(t);

        const tog=document.createElement("label"); tog.className="switch";
        const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=f.available;
        cb.onchange=()=>{f.available=cb.checked;renderFields();};
        const sl=document.createElement("span"); sl.className="slider";
        tog.appendChild(cb); tog.appendChild(sl); w.appendChild(tog);

        const bw=document.createElement("div"); bw.style.marginTop="8px";
        commonActivities.forEach(act=>{
          const b=document.createElement("button"); b.textContent=act; b.className="activity-button";
          if(f.activities.includes(act)) b.classList.add("active");
          b.onclick=()=>{ if(f.activities.includes(act)) f.activities=f.activities.filter(a=>a!==act); else f.activities.push(act); renderFields(); };
          bw.appendChild(b);
        });
        w.appendChild(bw);

        const other=document.createElement("input"); other.placeholder="Other activity";
        other.onkeyup=e=>{
          if(e.key==="Enter" && other.value.trim()){
            const v=other.value.trim(); if(!f.activities.includes(v)) f.activities.push(v);
            other.value=""; renderFields();
          }
        };
        w.appendChild(other);

        if(f.activities.length>0){
          const p=document.createElement("p"); p.style.marginTop="6px"; p.textContent="Activities: "+f.activities.join(", ");
          w.appendChild(p);
        }
        c.appendChild(w);
      });
    }

    function addSpecial(){
      const i=document.getElementById("specialInput"); const n=i.value.trim();
      if(n){specialActivities.push({name:n,available:true}); i.value=""; renderSpecials();}
    }
    document.getElementById("addSpecialBtn").onclick=addSpecial;
    document.getElementById("specialInput").addEventListener("keyup",e=>{if(e.key==="Enter")addSpecial();});

    function renderSpecials(){
      const c=document.getElementById("specialList"); c.innerHTML="";
      specialActivities.forEach(s=>{
        const w=document.createElement("div"); w.className="fieldWrapper"; if(!s.available)w.classList.add("unavailable");
        const t=document.createElement("span"); t.className="fieldTitle"; t.textContent=s.name;
        makeEditable(t,newName=>{s.name=newName;renderSpecials();}); w.appendChild(t);

        const tog=document.createElement("label"); tog.className="switch";
        const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=s.available;
        cb.onchange=()=>{s.available=cb.checked;renderSpecials();};
        const sl=document.createElement("span"); sl.className="slider";
        tog.appendChild(cb); tog.appendChild(sl); w.appendChild(tog);

        c.appendChild(w);
      });
    }

    // -------------------- Leagues --------------------
    function renderLeagues(){
      const container=document.getElementById("leaguesContainer");
      container.innerHTML="";
      availableDivisions.forEach(divName=>{
        if(!leagues[divName]) leagues[divName]={enabled:false,sports:[]};
        const wrap=document.createElement("div"); wrap.className="fieldWrapper";

        const title=document.createElement("span"); title.className="fieldTitle"; title.textContent=divName;
        wrap.appendChild(title);

        const toggle=document.createElement("label"); toggle.className="switch";
        const cb=document.createElement("input"); cb.type="checkbox"; cb.checked=leagues[divName].enabled;
        cb.onchange=()=>{leagues[divName].enabled=cb.checked; renderLeagues();};
        const slider=document.createElement("span"); slider.className="slider";
        toggle.appendChild(cb); toggle.appendChild(slider);
        wrap.appendChild(toggle);

        const btnWrap=document.createElement("div"); btnWrap.style.marginTop="8px";
        leagueSports.forEach(sport=>{
          const btn=document.createElement("button"); btn.textContent=sport; btn.className="activity-button";
          if(leagues[divName].sports.includes(sport)) btn.classList.add("active");
          btn.onclick=()=>{
            if(leagues[divName].sports.includes(sport)){
              leagues[divName].sports = leagues[divName].sports.filter(s=>s!==sport);
            } else {
              leagues[divName].sports.push(sport);
            }
            renderLeagues();
          };
          btnWrap.appendChild(btn);
        });
        wrap.appendChild(btnWrap);

        const other=document.createElement("input"); other.placeholder="Other sport";
        other.onkeyup=e=>{
          if(e.key==="Enter" && other.value.trim()){
            const val=other.value.trim();
            if(!leagues[divName].sports.includes(val)) leagues[divName].sports.push(val);
            other.value=""; renderLeagues();
          }
        };
        wrap.appendChild(other);

        if(leagues[divName].sports.length>0){
          const chosen=document.createElement("p"); chosen.style.marginTop="6px";
          chosen.textContent="Sports: "+leagues[divName].sports.join(", ");
          wrap.appendChild(chosen);
        }
        container.appendChild(wrap);
      });
    }

    // -------------------- Scheduling Core (Unified Grid) --------------------
    function assignFieldsToBunks() {
      // Build activity universe
      const availFields = fields.filter(f => f.available && f.activities.length>0);
      const availSpecials = specialActivities.filter(s => s.available);

      const allActivities = [
        ...availFields.flatMap(f => f.activities.map(act => ({type:"field", field:f, sport:act}))),
        ...availSpecials.map(sa => ({type:"special", field:{name:sa.name}, sport:null}))
      ];
      if (allActivities.length === 0) { alert("No activities available."); scheduleAssignments={}; return; }

      // init schedules
      scheduleAssignments = {};
      availableDivisions.forEach(div=>{
        divisions[div].bunks.forEach(b=>{ scheduleAssignments[b]=new Array(unifiedTimes.length); });
      });

      // Activity span in rows
      const inc = parseInt(document.getElementById("increment").value);
      const spanLen = Math.max(1, Math.ceil(activityDuration / inc));

      // Pick a league slot per division (must be in active rows)
      const leagueSlotByDiv = {};
      availableDivisions.forEach(div=>{
        if (leagues[div] && leagues[div].enabled) {
          const active = Array.from(divisionActiveRows[div] || []);
          if (active.length>0) {
            leagueSlotByDiv[div] = active[Math.floor(Math.random()*active.length)];
          }
        }
      });

      // Per unified time row
      for (let s=0; s<unifiedTimes.length; s++){
        // For each division, we track used fields this row to avoid conflicts
        const usedFieldsByDiv = {};
        availableDivisions.forEach(div=>{
          usedFieldsByDiv[div] = new Set();

          // mark fields in continuations already running at this row
          divisions[div].bunks.forEach(bunk=>{
            const entry = scheduleAssignments[bunk][s];
            if (entry && entry.continuation) usedFieldsByDiv[div].add(entry.field);
          });
        });

        for (let div of availableDivisions) {
          const isActiveRow = divisionActiveRows[div] && divisionActiveRows[div].has(s);
          if (!isActiveRow) continue;

          for (let bunk of divisions[div].bunks) {
            // If this row is part of a previous span, continue it (already marked)
            if (scheduleAssignments[bunk][s] && scheduleAssignments[bunk][s].continuation) continue;

            // Compute last non-null entry before s
            let lastIdx = s-1, lastEntry = null;
            while (lastIdx>=0 && !scheduleAssignments[bunk][lastIdx]) lastIdx--;
            if (lastIdx>=0) lastEntry = scheduleAssignments[bunk][lastIdx];

            // ---- Leagues handling (one slot per division) ----
            if (leagueSlotByDiv[div] === s && leagues[div] && leagues[div].enabled) {
              // avoid back-to-back leagues by shifting forward for this bunk
              if (lastEntry && lastEntry.isLeague) {
                // push division league slot forward to next active row not right after another league
                let next = s+1;
                while (next<unifiedTimes.length && (!divisionActiveRows[div].has(next))) next++;
                leagueSlotByDiv[div] = Math.min(next, unifiedTimes.length-1);
              }
              if (leagueSlotByDiv[div] === s) {
                scheduleAssignments[bunk][s] = { field:"Leagues", sport:null, continuation:false, isLeague:true };
                // span forward within active rows
                let placed = 1, k = 1;
                while (placed < spanLen && (s+k)<unifiedTimes.length && divisionActiveRows[div].has(s+k)) {
                  scheduleAssignments[bunk][s+k] = { field:"Leagues", sport:null, continuation:true, isLeague:true };
                  placed++; k++;
                }
                usedFieldsByDiv[div].add("Leagues");
                continue;
              }
            }

            // ---- Regular activities ----
            // If a previous span should continue (within active rows)
            if (lastEntry && !lastEntry.continuation) {
              // Count how many continuation rows already set after last start
              let countDone = 1;
              let t = lastIdx+1;
              while (t<s && scheduleAssignments[bunk][t] && scheduleAssignments[bunk][t].continuation) { countDone++; t++; }
              if (countDone < spanLen) {
                // continue it
                scheduleAssignments[bunk][s] = { field:lastEntry.field, sport:lastEntry.sport, continuation:true, isLeague:lastEntry.isLeague||false };
                usedFieldsByDiv[div].add(lastEntry.field);
                continue;
              }
            }

            // Build candidates excluding used fields at this row for this division
            let candidates = allActivities.filter(c => !usedFieldsByDiv[div].has(c.field.name));

            // Exclude back-to-back same sport/field/special
            candidates = candidates.filter(c => {
              if (!lastEntry) return true;
              if (lastEntry.isLeague) {
                if (c.field.name === "Leagues") return false; // avoid back-to-back leagues anyway
                if (c.type==="field" && c.field.name === lastEntry.field) return false;
              }
              if (c.type==="field" && lastEntry.sport && c.sport === lastEntry.sport) return false;
              if (c.field.name === lastEntry.field) return false;
              return true;
            });

            // Simple fairness tracker (avoid overusing same items)
            scheduleAssignments.__done = scheduleAssignments.__done || {};
            scheduleAssignments.__done[bunk] = scheduleAssignments.__done[bunk] || new Set();
            const doneSet = scheduleAssignments.__done[bunk];
            const preferred = candidates.filter(c => !doneSet.has(c.type==="field" ? c.sport : c.field.name));
            let chosen = (preferred.length>0 ? preferred : candidates)[Math.floor(Math.random()*(preferred.length>0 ? preferred.length : candidates.length) )];

            // fallback if no candidate
            if (!chosen && allActivities.length>0) {
              let tries = allActivities.slice();
              do {
                chosen = tries.splice(Math.floor(Math.random()*tries.length),1)[0];
              } while (chosen && lastEntry && (chosen.field.name===lastEntry.field || chosen.sport===lastEntry.sport) && tries.length>0);
            }
            if (!chosen) continue;

            // place chosen and span forward inside active rows
            scheduleAssignments[bunk][s] = { field:chosen.field.name, sport:chosen.sport, continuation:false, isLeague:false };
            usedFieldsByDiv[div].add(chosen.field.name);
            doneSet.add(chosen.type==="field" ? chosen.sport : chosen.field.name);

            let placed = 1, k=1;
            while (placed < spanLen && (s+k) < unifiedTimes.length && divisionActiveRows[div].has(s+k)) {
              scheduleAssignments[bunk][s+k] = { field:chosen.field.name, sport:chosen.sport, continuation:true, isLeague:false };
              placed++; k++;
            }
          }
        }
      }
    }

    // -------------------- Rendering (Unified Grid + Merged Cells) --------------------
    function updateTable(){
      const scheduleTab = document.getElementById("schedule");
      scheduleTab.innerHTML = ""; // clear

      if (unifiedTimes.length === 0) return;

      // Clear any previous _skip flags
      Object.keys(scheduleAssignments).forEach(b=>{
        if (Array.isArray(scheduleAssignments[b])) {
          scheduleAssignments[b].forEach(e=>{ if(e) delete e._skip; });
        }
      });

      const table=document.createElement("table");
      table.className="division-schedule";

      // Header rows
      const thead=document.createElement("thead");

      const row1=document.createElement("tr");
      const thTime=document.createElement("th"); thTime.textContent="Time"; row1.appendChild(thTime);
      availableDivisions.forEach(div=>{
        const th=document.createElement("th");
        th.colSpan = divisions[div].bunks.length || 1;
        th.textContent=div;
        th.style.background=divisions[div].color; th.style.color="#fff";
        row1.appendChild(th);
      });
      thead.appendChild(row1);

      const row2=document.createElement("tr");
      const thBunkLabel=document.createElement("th"); thBunkLabel.textContent="Bunk"; row2.appendChild(thBunkLabel);
      availableDivisions.forEach(div=>{
        divisions[div].bunks.forEach(b=>{
          const th=document.createElement("th"); th.textContent=b; row2.appendChild(th);
        });
      });
      thead.appendChild(row2);
      table.appendChild(thead);

      const tbody=document.createElement("tbody");

      for (let s=0; s<unifiedTimes.length; s++){
        const tr=document.createElement("tr");
        const tdTime=document.createElement("td"); tdTime.textContent=unifiedTimes[s].label; tr.appendChild(tdTime);

        availableDivisions.forEach(div=>{
          const activeSet = divisionActiveRows[div] || new Set();
          divisions[div].bunks.forEach(bunk=>{
            // Skip if part of a merged cell from a previous row
            if (scheduleAssignments[bunk] && scheduleAssignments[bunk][s] && scheduleAssignments[bunk][s]._skip) return;

            const td=document.createElement("td");
            const isActive = activeSet.has(s);

            if (!isActive) {
              td.className="grey-cell";
              tr.appendChild(td);
              return;
            }

            const entry = scheduleAssignments[bunk] ? scheduleAssignments[bunk][s] : null;
            if (entry && !entry.continuation) {
              // determine rowspan by scanning forward over continuation rows
              let span=1;
              for (let k=s+1; k<unifiedTimes.length; k++){
                const e2 = scheduleAssignments[bunk][k];
                if (!e2 || !e2.continuation || e2.field!==entry.field || e2.sport!==entry.sport || e2.isLeague!==entry.isLeague) break;
                span++;
                // mark skip so we don't render duplicate cells
                scheduleAssignments[bunk][k]._skip = true;
              }
              td.rowSpan = span;
              if (entry.isLeague) {
                td.innerHTML = `<span class="league-pill">Leagues</span>`;
              } else {
                td.textContent = entry.sport ? `${entry.field} – ${entry.sport}` : entry.field;
              }
            } else if (!entry) {
              td.textContent = ""; // empty (should be rare if activities exist)
            } else {
              // continuation handled by skip/rowspan
            }

            tr.appendChild(td);
          });
        });

        tbody.appendChild(tr);
      }

      table.appendChild(tbody);
      scheduleTab.appendChild(table);
    }

    // -------------------- Init --------------------
    document.getElementById("addFieldBtn").disabled = false;
  </script>
</body>
</html>
